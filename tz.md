# Техническое задание
# "strategy"
Версия 1.0

## Содержание:
1. Термины и определения
2. Цели и задачи
3. вход в игру
  3.1 Экран входа
  3.2 Экран регистрации
4. интерфейс  
  4.1 Главное меню
  4.2 Менеджмент деревни
  4.3 Игровой интерфейс
  4.4 Интерфейс глобальной карты
  4.5 интерфейс таблицы рейтинга
5. Игровой процесс
  5.1 Общая концепция
  5.2 Геймплей
  5.3 Система юнитов
  5.4 Здания
  5.5 Блок карты сражений
  5.6 Мультиплеер
  5.7 Экономическая система и улучшения зданий
  5.8 Стартовый пакет новичка
  5.9 Последствия неудачной атаки и поражения при защите
  5.10 Система чата и социальные функции
6. Пользовательские сценарии
  6.1 Вход в игру
  6.2 Регистрация
  6.3 Запуск атаки
  6.4 Сценарий пассивной атаки
  6.5 Навигация между Менеджментом деревни и Глобальной картой
  6.6 Процесс запуска атаки
  6.7 Система уведомлений о нападениях
7. Архитектура системы и база данных
  7.1 Общая архитектура
  7.2 Структура базы данных
  7.3 API Endpoints
  
---

## 1. Термины и определения

- **Игрок** – пользователь, вошедший в игру
- **Юнит** – управляемая боевая единица
- **Деревня** – база игрока на глобальной карте
- **Глобальная карта** – карта, показывающая расположение всех деревень игроков
- **Менеджмент деревни** – карта деревни игрока, на которой происходят сражения
- **Ратуша** – главное строение; при уничтожении которого признается поражение
- **Спавн** – место появления новой деревни на глобальной карте
- **Рейд** – нападение на деревню другого игрока
- **Монеты** – единственная игровая валюта
- **Скорость армии** – скорость перемещения армии по глобальной карте, определяемая самым медленным юнитом в отряде

## 2. Цели и задачи

**Цель:** Разработать успешную MMO-стратегию с элементами PvP и строением базы.

**Задачи:**
1. Реализовать клиентскую часть проекта
2. Реализовать серверную часть проекта  
3. Создать глубокий, но доступный геймплей
4. Обеспечить стабильную работу мультиплеера
5. Протестировать работу приложения

## 3. Вход в игру 

### 3.1 Экран входа
Состоит из двух полей ввода:
1. Логин
2. Пароль(при вводе зашифровано точками)
3. чекбокс "запомнить меня"

И кнопок:
1. "Авторизоваться"
2. "зарегистрироваться"

### 3.2 Экран регистрации  
1. **Поле ввода "Логин"**
   - Валидация в реальном времени
   - Индикатор доступности логина

2. **Поле ввода "пароль"**  
   - при вводе зашифровано точками

3. **Поле ввода "Подтверждение пароля"**
   - Сравнение с исходным пароле
   - Визуальное подтверждение совпадения

4.   **Поле ввода "отображаемое имя"**

4. **Кнопка "Зарегистрироваться"**
   - Активируется только при выполнении всех требований

### требования логина и пароля
**Требования к логину:**
- Длина: от 5 до 20 символов
- Допустимые символы: латинские буквы (a-z, A-Z), цифры (0-9), символы подчеркивания (_)
- Не должен начинаться с цифры или символа подчеркивания
- Не должен содержать пробелов и специальных символов (@, #, $, %)
- Должен быть уникальным (проверка на занятость в реальном времени)
- не должен представлять из себя персональную информацию  
- логин не должен совпадать с паролем

**Требования к паролю:**
- Минимальная длина: 8 символов
- Обязательное использование символов разных регистров (A-Z, a-z)
- Обязательное наличие хотя бы одной цифры (0-9)
- Рекомендуется использование специальных символов (!@#$%^&*)
- Не должен содержать персональную информацию (логин, имя, дату рождения)
- не должен представлять из себя персональную информацию 
- пароль не должен совпадать с логином 

**Дополнительные элементы:**
   - Ссылка "Забыли пароль?" для восстановления доступа
   - Ссылка "Создать аккаунт" для перехода к регистрации
   - Чекбокс "Запомнить меня" для сохранения сессии

   **забыли пароль:**
    - просит ввести логин 

## 4. интерфейс

### 4.1 Главное меню
Кнопки:
1. Авторизация
2. Регистрация

**Общее описание:**
Главное меню представляет собой центральный хаб для навигации по игровым разделам и доступа к основным функциям. Интерфейс отличается интуитивной понятностью и визуальной привлекательностью.

**Структура и компоновка:**

1. **Центральная панель навигации**
   - Поле логин - введение логина игрока
   - Поле пароль - введение пароля
   - Кнопка авторизации - если введены валидные данные, то будет осуществлен вход в игру, иначе ошибка
   - Кнопка регистрации - нажатие перекинет на страницу регистрации
   - Кнопка авторизации с помощью Госуслуг - перекидывает на Рикролл (Rickroll)
   - Кнопка авторизации с помощью отечественного мессенджера Max - перекидывает на Рикролл (Rickroll)

**Визуальные элементы и оформление:**

- **Система уведомлений**
  - Предупреждения о атаках на деревню


**Функциональные возможности:**

- **Система профиля игрока**
  - Быстрый просмотр статистики

**Технические характеристики:**

- **Производительность**
  - Время загрузки: не более 3 секунд
  - Отклик интерфейса: < 50 мс

- **Адаптивность**
  - Поддержка разрешений от 1280×720 до 4K
  - Масштабируемость интерфейса
  - Оптимизация для различных браузеров

### 4.2 Менеджмент деревни (Интерфейс управления деревней)

**Общее описание:**
Менеджмент деревни представляет собой игровое пространство , разделенное на три функциональные зоны равного размера (29×29 клеток каждая). Интерфейс обеспечивает полный контроль над развитием и защитой деревни.

**Структура карты:**

| Зона | Размер | Назначение | Особенности |
|------|--------|------------|-------------|
| **Зона строительства** | 29×29 клеток | Размещение зданий и оборонительных сооружений | - Сетка с визуальным выделением клеток - Подсветка доступных/недоступных позиций - Визуализация радиуса действия оборонительных сооружений |
| **Зона размещения юнитов** | 29×29 клеток | Формирование и позиционирование армии | - Разделение на секторы для разных типов юнитов - Индикация вместимости каждого сектор - Визуальное отображение готовности юнитов |
| **Зона появления врагов** | 29×29 клеток |Нападающий игрок расставляет свои войска для атаки на деревню|

**Элементы интерфейса:**

1. **Панель строительства**
   - Категории зданий:  Оборона
   - Визуальные иконки с отображением стоимости и требований

2. **Панель управления юнитами**
   - зажав левую кнопку мыши и обведя юнитов,можно их выделить и дать дальнейшие указания 
   - Список доступных типов юнитов с характеристиками
   - Кнопки найма/тренировки с указанием стоимости
   - после найма/тренировки юнита он должен появляться на месте отмеченном курсором игрока

3. **Информационная панель**
   - Текущий баланс ресурсов (монеты)
   - Лимиты строительства и вместимости

4. **Инструменты навигации**
   - Приближение/отдаление камеры

**Функциональные возможности:**

- **Система размещения объектов:**
  - перетаскивание, размещение зданий и юнитов
  - Валидация позиций (проверка на пересечения)
  - Предпросмотр занимаемого места

- **Управление обороной:**
  - Расстановка оборонительных сооружений по периметру
  - Настройка приоритетов целей для башен
  
**Технические требования:**
- Поддержка разрешения от 1280×720
- Время отклика интерфейса: < 100 мс
- Поддержка горячих клавиш для основных операций

### 4.3 Игровой интерфейс
Информация о:
1. Текущем количестве монет
2. Здоровье юнитов
3. Времени похода (отображается в глобальной карте под иконкой деревни)
4. Текущих зданиях(название > уровень )

### 4.4 Интерфейс глобальной карты

**Общее описание:**
Глобальная карта представляет собой игровое пространство, отображающее расположение всех деревень игроков. Карта реализована в виде сетки (матрицы) с клеточным разделением.

**Структура и визуализация:**
- Отображение всех деревень игроков в виде значков/иконок
- Сетка с четким клеточным разделением (квадратные клетки)
- Визуальное выделение собственной деревни игрока


**Функциональные элементы интерфейса:**

1. **Панель навигации**
   - Приближение/отдаление карты
   - Перемещение по карте (перетаскивание)
   - Кнопка быстрого перехода к своей деревне

2. **Панель информации о цели**
   - Отображение информации о выбранной деревне (никнейм владельца)
   - Кнопка "Атаковать"
   - Визуализация времени доступа к цели (если применимо)

3. **Панель управления армией**
   - Отображение текущего состава отправляемой армии
   - Расчет и отображение стоимости похода
   - Таймер перемещения армии
   - Кнопка отмены/перенаправления похода

**Ключевые функциональные возможности:**

- **Система перемещения армии:**
  - Перемещение армии в реальном времени по клеткам карты
  - Иконка движущейся армии
  - Отображение времени в пути
  - Расчетное время прибытия с учетом скорости самого медленного юнита

- **Логистика и снабжение:**
  - Динамический расчет стоимости содержания армии в походе
  - Визуальное предупреждение о недостатке ресурсов
  - Автоматическая остановка армии при исчерпании монет

- **Механика размещения новых игроков:**
  - Автоматический подбор места спавна с минимальным расстоянием от существующих игроков
  - Защищенная зона для новичков (невозможность атаки в течение начального периода)

**Технические требования:**
- Поддержка одновременного отображения 100+ объектов на карте
- Время отклика на действия: < 200 мс
- Плавная анимация перемещения камеры и объектов
- Оптимизация для работы в браузере

**Особенности геймплея:**
- Возможность отмены похода до момента боевого столкновения
- Визуализация текущих атак на другие деревни
- Ограничение на частоту атак на одного игрока

### 4.5 Таблица рейтинга

**Общее описание:**
Таблица рейтинга представляет собой систему ранжирования игроков на основе их достижений в PvP-сражениях. Рейтинговая система стимулирует соревновательный дух и предоставляет игрокам видимые цели для развития.

**Структура рейтинговой таблицы:**

1. **Основная таблица лидеров**
   - Колонка "Место" - позиция игрока в общем зачете
   - Колонка "Никнейм" - имя игрока
   - Колонка "Количество побед" - общее число успешных атак
   - Колонка "Уровень" - текущий уровень развития деревни

2. **Секция персональной статистики**
   - Текущая позиция игрока в рейтинге
   - Количество побед/поражений за текущий сезон
   - Прогресс до следующей рейтинговой лиги
   - История последних сражений

**Функциональные элементы интерфейса:**

1. **Панель фильтрации и сортировки**
   - Сортировка по количеству побед/уровню/активности
   - Поиск конкретного игрока по нику

2. **Панель навигации по сезонам**
   - Отображение текущего сезона и времени до его завершения
   - Архив предыдущих сезонов

3. **Информационная панель наград**
   - Отображение доступных наград за текущую позицию
   - Таймер до сброса рейтинга
   - Условия получения специальных наград

**Ключевые функциональные возможности:**

- **Система подсчета очков:**
  - Базовая награда за каждую победу: +1 к рейтингу

- **Механика сезонных сбросов:**
  - Ежемесячный вайп рейтинговых очков

**Визуальные элементы:**
- иконки лиг и рангов
- Индикаторы онлайн-статуса в таблице
- Анимация изменения позиций в реальном времени

**Система наград:**

| Место | Награды |
|-------|---------|
| **1 место**     | Видеопоздравление от разработчиков |

**Технические требования:**
- Обновление рейтинга в реальном времени
- Поддержка до 200 игроков в таблице
- Быстрый поиск и фильтрация (< 100 мс)
- Кросс-платформенная синхронизация данных

**Особенности геймплея:**
- Рейтинг не влияет на игровой процесс (баланс сил)
- Прозрачная система подсчета очков
- Защита от накрутки рейтинга

## 5. Игровой процесс

### 5.1 Общая концепция
Браузерная MMO-стратегия с элементами PvP и Tower Defense. Игроки развивают деревни, собирают армии и сражаются друг с другом.

### 5.2 Геймплей
Игрок запускает игру в браузере, входит или регистрируется.

### 5.3 Система юнитов

**Общее описание:**
В игре представлены 8 типов юнитов с уникальными характеристиками, стоимостью и особенностями. Юниты открываются последовательно при улучшении Казарм.

#### Характеристики юнитов:

**1. Мечник**
- **Здоровье:** 100 HP
- **Урон:** 15 DPS
- **Дальность атаки** 1 клетка
- **Скорость:** 1.0 клетка/сек
- **Стоимость:** 50 монет
- **Открытие:** Казармы уровень 1

**2. Копейщик**
- **Здоровье:** 60 HP
- **Урон:** 10 DPS
- **Дальность атаки** 2 клетка
- **Скорость:** 1.0 клетка/сек
- **Стоимость:** 30 монет
- **Открытие:** Казармы уровень 1

**3. Берсерк**
- **Здоровье:** 90 HP
- **Урон:** 35 DPS
- **Дальность атаки** 1 клетка
- **Скорость:** 1.3 клетки/сек
- **Стоимость:** 120 монет
- **Открытие:** Казармы уровень 1

**4. Паладин**
- **Здоровье:** 300 HP
- **Урон:** 25 DPS
- **Дальность атаки** 1 клетка
- **Скорость:** 0.7 клетки/сек
- **Стоимость:** 300 монет
- **Открытие:** Казармы уровень 3

**5. Страж**
- **Здоровье:** 400 HP
- **Урон:** 12 DPS
- **Дальность атаки** 1 клетка
- **Скорость:** 0.5 клетки/сек
- **Стоимость:** 250 монет
- **Открытие:** Казармы уровень 3

**6. Лучник**
- **Здоровье:** 70 HP
- **Урон:** 18 DPS
- **Дальность атаки** 6 клеток
- **Скорость:** 1.0 клетка/сек
- **Стоимость:** 60 монет
- **Открытие:** Казармы уровень 1

**7. Арбалетчик**
- **Здоровье:** 110 HP
- **Урон:** 28 DPS
- **Дальность атаки** 5 клеток
- **Скорость:** 0.8 клетки/сек
- **Стоимость:** 150 монет
- **Открытие:** Казармы уровень 2


**8. Рыцарь**
- **Здоровье:** 180 HP
- **Урон:** 30 DPS
- **Скорость:** 1.0 клетка/сек
- **Стоимость:** 200 монет
- **Открытие:** Казармы уровень 2


### Визуальные эффекты и анимации юнитов

Каждый тип юнита имеет анимацию атаки

   **Ближний бой** (Мечник, Копейщик, Берсерк и т.д.):
     - Анимация замаха и удара оружием
     - Визуальные эффекты столкновения с целью
   **Дальний бой** (Лучник, Арбалетчик):
     - Анимация выстрела/заклинания
     - Визуальный снаряд (стрела, болт, магический шар), летящий к цели
     - Эффект попадания в цель

   **Система смерти и разложения юнитов:**

    При достижении 0 HP юнит не исчезает мгновенно, а проходит стадии разложения:
     - **Труп (0-10 секунд):** Юнит падает на землю как труп
     - **Разложение (10-20 секунд):** Визуальные изменения (изменение цвета, текстуры)
     - **Могилка (после 30 секунд):** Превращается в каменную плиту/могилу
   
    **Механика уборки:**
      - Могилки можно убирать после боя за дополнительную плату
      - Стоимость уборки: 10 монет за могилку
      - Уборка мгновенная, выполняется через контекстное меню

#### Лимиты и баланс:

**Стратегические рекомендации:**
- Экономическая эффективность vs боевая мощь
**Общее описание:**
Разблокировка новых типов юнитов происходит через улучшение Казарм. Каждый уровень Казарм открывает доступ к новым юнитам.

### 5.4 Система зданий

**Общее описание:**
Каждое здание имеет уникальные характеристики, включая здоровье, стоимость и улучшения. Все здания могут быть разрушены в ходе боя. Максимальный уровень для всех зданий - 3

#### Детальные характеристики зданий:

**1. Ратуша (Главное здание)**
- **Назначение:** Определяет уровень развития деревни
- **Размер:** 2×2 клетки
- **Здоровье:** 
  - Уровень 1: 800  HP
  - Уровень 2: 1100  HP
  - Уровень 3: 1500 HP
- **Стоимость улучшения:** 800 - 2 уровень, 1200 - 3 уровень
- **Особенности:** Поражение при уничтожении
- **Открытие:** Стартовое здание

**2. Шахта (Экономическое здание)**
- **Назначение:** Добыча монет
- **Размер:** 2×2 клетки
- **Здоровье:**
  - Уровень 1: 100 HP
  - Уровень 2: 200 HP
  - Уровень 3: 300 HP
- **Производство:**
  - Уровень 1: 10 монет/минуту
  - Уровень 2: 20 монет/минуту
  - Уровень 3: 30 монет/минуту
- **Стоимость улучшения:** 300 - 2 уровень, 600 - 3 уровень
- **Открытие:** Стартовое здание

**3. Казармы (Военное здание)**
- **Назначение:** Производство юнитов
- **Размер:** 2×2 клетки
- **Здоровье:**
  - Уровень 1: 600 HP
  - Уровень 2: 850 HP
  - Уровень 3: 1150 HP
- **Стоимость покупки:** 400
- **Стоимость улучшения:** 500 - 2 уровень, 900 - 3 уровень
- **Открытие:** Ратуша уровень 1

**4. Стены (Оборонительное сооружение)**
- **Назначение:** Защита и замедление врагов
- **Размер:** 1×1 клетка
- **Здоровье:**
  - Уровень 1: 200 HP
  - Уровень 2: 300 HP
  - Уровень 3: 400 HP
- **Стоимость покупки:** 100
- **Стоимость улучшения:** 200 - 2 уровень, 300 - 3 уровень
- **Особенности:** Полное разрушение требует перестройки
- **Открытие:** Ратуша уровень 1

**5. Стрелковая башня (Оборонительное сооружение)**
- **Назначение:** Атака вражеских юнитов
- **Размер:** 2×2 клетка
- **Здоровье:**
  - Уровень 1: 300 HP
  - Уровень 2: 400 HP
  - Уровень 3: 500 HP

- **Характеристики атаки:**
  - Уровень 1: урон 18, дальность 5 клеток
  - Уровень 2: урон 25, дальность 6 клеток
  - Уровень 3: урон 35, дальность 7 клеток
- **Стоимость покупки:** 200
- **Стоимость улучшения:** 300 - 2 уровень, 500 - 3 уровень
- **Открытие:** Ратуша уровень 1

**6. Вьетнамская ловушка (Оборонительное сооружение)**
- **Назначение:** Атака вражеских юнитов
- **Размер:** 1×1 клетка
- **Здоровье:**
  - Уровень 1: 1 HP
  - Уровень 2: 1 HP
  - Уровень 3: 1 HP

- **Характеристики атаки:**
  - Уровень 1: урон 25, уничтожение после использования
  - Уровень 2: урон 50, уничтожение после использования
  - Уровень 3: урон 65, уничтожение после использования
- **Стоимость покупки:** 50
- **Стоимость улучшения:** 75 - 2 уровень, 100 - 3 уровень
- **Открытие:** Ратуша уровень 2

**7. Пушка (Оборонительное сооружение)**
- **Назначение:** Атака вражеских юнитов
- **Размер:** 1×1 клетка
- **Здоровье:**
  - Уровень 1: 400 HP
  - Уровень 2: 500 HP
  - Уровень 3: 600 HP

- **Характеристики атаки:**
  - Уровень 1: урон 30
  - Уровень 2: урон 50
  - Уровень 3: урон 70
- **Стоимость покупки:** 500
- **Стоимость улучшения:** 700 - 2 уровень, 1100 - 3 уровень
- **Открытие:** Ратуша уровень 3 


#### Механика строительства и улучшений:

**Ограничения строительства:**
- Правила размещения: отсутствие пересечений хитбоксов
- Невозможные позиции подсвечиваются красным цветом

**Процесс строительства:**
1. Выбор места на сетке 29×29 клеток
2. Проверка валидности позиции
3. Оплата стоимости строительства

**Восстановление после боя:**
- **Ратуша и Шахта:** Автоматическое бесплатное восстановление
- **Казармы:** Автоматическое восстановление за 50% стоимости
- **Оборонительные сооружения:** Разрушаются и требуют восстановления


### 5.5 Блок карты сражений

**Общее описание:**
Карта сражений представляет собой игровое пространство для проведения рейдов и обороны деревни. Карта разделена на функциональные зоны и обеспечивает тактическое управление юнитами в реальном времени.

**Структура карты:**

| Зона | Размер | Назначение | Особенности |
|------|--------|------------|-------------|
| **Зона строительства** | 29×29 клеток | Территория защищающегося игрока | - Фиксированное расположение ратуши (верхняя часть по центру)<br>- Размещение оборонительных сооружений<br>- Стратегическое позиционирование защитных юнитов |
| **Зона размещения юнитов** | 29×29 клеток | Территория для размещения атакующих сил | - Начальная позиция атакующего игрока (нижняя часть карты)<br>- Возможность расстановки юнитов перед началом боя<br>- |
| **Зона появления врагов** | 29×29 клеток | Основное поле боя | Клеточная система перемещения |

**Элементы интерфейса во время сражения:**

1. **Панель управления армией**
   - Выделение групп юнитов (зажатие правой кнопки мыши)
   - Приоритизация целей (ратуша, башни, другие здания)

2. **Тактическая панель**
   - Индикатор прогресса атаки/обороны(можно реализовать шкалой которая заполняется по степени нанесенного урона зданиям)

3. **Информационная панель**
   - Состав и состояние атакующих/защищающихся сил

**Ключевые функциональные возможности:**

- **Система управления юнитами:**
  - Автоматический поиск пути (алгоритм EasyStar)
  - Ручное назначение целей для каждого юнита/группы

- **Механика столкновений:**
  - Юниты являются преградами друг для друга

**Визуальные элементы:**
- Цветовое кодирование юнитов (свои/чужие)
- Индикаторы здоровья над объектами
- Эффекты анимации атак и перемещений

**Переход к ИИ управлению:**
- При отключение одного из игроков(атакующий/защищающий) во время атаки его армией будет управлять ИИ

**Технические требования:**
- Время отклика на команды: < 100 мс
- Поддержка до 100 одновременно активных юнитов
- Оптимизированные алгоритмы поиска пути

**Особенности геймплея:**
- Автоматическое ИИ-управление
- Мгновенное возвращение юнитов на базу после успешного рейда
- Ограничение на одновременные атаки одной базы
- Если из игры вышли оба игрока, то атака завершается и юниты возвращаются на свои базы

### 5.6 Мультиплеер
Игроки могут атаковать деревни друг друга. За успешные атаки начисляется рейтинг.

### 5.7 Экономическая система и улучшения зданий

**Общее описание:**
Экономика игры построена на едином ресурсе - монетах, которые добываются в шахте. Система улучшений зданий обеспечивает прогрессию игрока и стратегическое развитие деревни.

**Базовая экономическая модель:**

1. **Источники дохода:**
   - Шахта: основной источник монет (1 на деревню)
   - Успешные рейды: бонусные монеты за победы

2. **Основные расходы:**
   - Строительство новых зданий
   - Улучшение существующих построек
   - Наем армии
   - Логистика военных походов

**Стратегические аспекты:**

- **Приоритеты развития:**
- Ранняя игра: фокус на шахте и экономике
- Средняя игра: баланс между экономикой и обороной
- Поздняя игра: специализация под стиль игры

**Технические требования:**
- Автоматическое начисление доходов каждую минуту
- Синхронизация между клиентом и сервером

**Баланс и прогрессия:**
- Мягкие ограничения для новых игроков
- Стимулы для регулярного улучшения построек
- Прозрачная система экономических расчетов

### 5.8 Стартовый пакет новичка

**Начальная база и защита:**
- **Базовая деревня:** Стандартный набор построек на карте 29×29 клеток

**Стартовые здания:**
- **Ратуша** (1 шт.) - расположена в верхней части карты по середине
- **Шахта** (1 шт.) - единственный источник монет (начальный уровень)

**Начальные ресурсы:**
- **Монеты:** Стартовый запас для первого строительства и найма армии

**Особенности стартовой позиции:**
- Автоматический подбор места спавна с минимальным расстоянием от других игроков
- Сбалансированные начальные ресурсы (одинаковые возможности для всех новичков)
- Предустановленная расстановка ключевых зданий

**Ограничения для новичков:**
- Базовый уровень всех построек

**Процесс развития новичка:**
1. Освоение интерфейса управления деревней
2. Первые улучшения шахты для увеличения добычи монет
3. Строительство дополнительных оборонительных сооружений
4. Формирование первой армии для тестовых атак
5. Изучение глобальной карты и механики рейдов


### 5.9 Последствия неудачной атаки и поражения при защите

**Общее описание:**
Система потерь и наказаний за неудачные боевые действия сбалансирована для поддержания здоровой конкурентной среды.

#### Последствия для атакующего при неудачной атаке:

**1. Потери юнитов:**
- **Все юниты**, которые погибли при нападении, уничтожаются
- **Восстановление:** Требуется полный повторный найм уничтоженных юнитов

**2. Экономические потери:**
- **Потеря ресурсов,** потраченных на содержание армии во время похода
- **Невозвратные затраты** на найм уничтоженных юнитов


#### Последствия для защищающегося при проигрыше:

**1. Экономические потери:**
- **Кража ресурсов:** Атакующий забирает 15% от текущего запаса монет
- **Защитный лимит:** Минимальный остаток 100 монет гарантирован

**2. Разрушения:**
- **Оборонительные сооружения** от зданий остаются руины и они требуют восстановления за 80% от стоимости
- **Ключевые здания** Шахта восстанавливается автоматически
- **Время восстановления:** моментальное

**3. Рейтинговые потери:**
- **-1 пункт рейтинга** за каждое поражение в защите

**4. Временные эффекты:**
- **Запрет на атаки:** игрок не может атаковать или быть атакованым пока не восстановит ратушу

#### Система смягчения потерь для новых игроков:

**Визуальное отображение потерь:**
- счетчик потерь ресурсов
- Уведомления о рейтинговых изменениях

## 5.10 Система чата и социальные функции

**Общее описание:**
Система чата предоставляет игрокам возможность для текстового общения, координации действий и создания игрового сообщества.

### 5.10.1 Структура чатов

**1. Глобальный чат**
- **Назначение:** Общение всех игроков онлайн
- **Доступность:** Все зарегистрированные игроки

### 5.10.2 Элементы интерфейса

**1. Основное окно чата**
- **Расположение:** Левый нижний угол экрана
- **Функциональность:**
  - Переключение между типами чатов

**2. Контекстное меню игрока**
- **Доступ:** Правый клик по нику в чате
- **Функции:**
  - "Написать сообщение"

### 5.10.3 Технические требования

**1. Производительность:**
- Время доставки сообщений: < 100 мс
- Автосохранение истории переписки

**2. Система уведомлений:**
- оповещения о новых сообщениях

## 6. Пользовательские сценарии

### 6.1 Вход в игру:
1. Пользователь вводит логин и пароль
2. Нажимает "Авторизоваться"
3. Попадает в главное меню

### 6.2 Регистрация:
1. Пользователь вводит данные
2. Нажимает "Зарегистрироваться"
3. Система создает аккаунт

### 6.3 Запуск атаки:
1. Выбирается деревня, на которую игрок хочет напасть
2. Нажимает кнопку "Атака"
3. Появляется информация о уровне ратуши и казармы деревни противника
4. Выбор юнитов
5. Появляется информация о стоимости похода и ожидается подтверждение атаки
6. Армия отправляется в путь, время которого зависит от удаленности деревень на глобальной карте,  защищающийся получает уведомление об атаке
7. Армия доходит, и обоих игроков перекидывает на поле боя

### 6.4 Сценарий пассивной атаки (игрок не действует)

**Общее поведение юнитов:**
При отсутствии игрока юниты переходят в автоматический режим, руководствуясь встроенным ИИ.

**Иерархия целей по приоритетам:**

1. **ПЕРВЫЙ ПРИОРИТЕТ - Вражеские юниты в радиусе атаки**

2. **ВТОРОЙ ПРИОРИТЕТ - . Ближайшее здание**

3. **ТРЕТИЙ ПРИОРИТЕТ - Ратуша**
   - Когда все оборонительные сооружения уничтожены, юниты атакуют ратушу
   - На пути к ратуше юниты могут атаковать второстепенные здания, если они блокируют путь

**Тактические особенности:**

- **Поиск пути:** Используется алгоритм EasyStar для обхода препятствий
- **Определение цели:** Каждый юнит выбирает ближайшего к себе врага и начинает атаковать его

**Критические ситуации:**

- **Тупиковая ситуация:** Если путь заблокирован, юниты атакуют препятствие
- **Потеря здоровья:** Юниты с низким здоровьем не меняют поведение

###  6.5 Навигация между Менеджментом деревни и Глобальной картой

**Общее описание:**
Система обеспечивает перемещение игрока между режимом управления деревней и глобальной картой с сохранением контекста текущих действий.

**Элементы навигации:**

1. **Кнопка переключения режимов**
   - Расположение: мини карта в правой части панели, при нажатии на нее открывается Глобальная карта
   - Визуальное оформление: мини карта в правой части панели


**Процесс перехода:**

**Из Менеджмента деревни на Глобальную карту:**
1. Игрок нажимает кнопку на мини карту
2. Перекидывает на Глобальную карту
3. Сохранение состояния интерфейса управления деревней

**С Глобальной карты в Менеджмент деревни:**
1. Нажатие на иконку 

**Контекстные переходы:**

**После успешного рейда:**
- Автоматическое возвращение в Менеджмент деревни
- Отображение экрана результатов атаки
- Автоматическое распределение добытых ресурсов

**При атаке на деревню игрока:**
- Прямой переход из Глобальной карты на карту сражения
- После боя - возврат на Глобальную карту в точку атаки

**Во время перемещения армии:**
- Возможность переключения между режимами без прерывания похода

**Технические требования:**
- Время перехода между режимами: < 2 секунды
- Сохранение состояния интерфейса при переключениях
- Синхронизация данных в реальном времени
- Кэширование данных для мгновенного доступа

**Обработка прерываний:**
- Предупреждение при переходе во время активного строительства
- Сохранение прогресса при неожиданном переключении
- Восстановление сессии после разрыва соединения

### 6.6 Процесс запуска атаки

**Общее описание:**
Процесс атаки запускается с Глобальной карты и включает несколько этапов перед началом непосредственного боя.

**Процесс запуска атаки:**

**1. Выбор цели и подтверждение:**
- Выбирается деревня, на которую игрок хочет напасть
- Нажимает кнопку "Атака"
- Появляется информация о уровне ратуши и казармы деревни противника
- Выбор юнитов
- Появляется информация о стоимости похода и ожидается подтверждение атаки
- Армия отправляется в путь, время которого зависит от удаленности деревень на глобальной карте,  защищающийся получает уведомление об атаке
- Армия доходит, и обоих игроков перекидывает на поле боя

**2. Формирование армии:**
- армия отправляется целиком
- Расчет общей стоимости содержания армии в походе
- Предупреждение при недостатке ресурсов

**3. Запуск похода:**
- После подтверждения армия начинает движение по Глобальной карте
- Визуализация: отряд отображается как движущаяся иконка от своей деревни к цели

**4. Процесс перемещения:**
- Игрок может наблюдать за продвижением армии на Глобальной карте
- Возможность отменить поход до достижения цели

**5. Начало боя:**
- При достижении цели армия исчезает с Глобальной карты
- Запускается сцена боя на карте деревни противника
- Атакующий игрок видит анимацию "Прибытие армии":
  - Появление юнитов в зоне атаки (левая часть карты)
  - Краткая пауза для расстановки сил (5-10 секунд)
  - Автоматический старт боя по истечении времени

**Особенности процесса:**

**Временные затраты:**
- Зависит от расстояния между деревнями и скорости армии

**Управление во время похода:**
- Отслеживание положения армии в реальном времени
- Возможность параллельных действий в Менеджменте деревни

**Техническая реализация:**
- Защита от модификации клиента
- Синхронизация состояния между участниками
- Резервное копирование данных боя

**Визуальные элементы:**
- иконка движущейся армии
- Прогресс-бар времени пути

### 6.7 Система уведомлений о нападениях

**Общее описание:**
Система информирует игрока о нападениях на его деревню во время его отсутствия в игре.

**Типы уведомлений:**

**1. Push-уведомления (вне игры):**
- **Приходят сразу** при начале нападения на деревню
- **Содержание:**
  - "Вашу деревню атакует [никнейм игрока]"
  - Время начала атаки

**Сценарий оффлайн-атаки:**

**Этап 1 - Начало атаки:**
- Игрок получает push-уведомление о начале нападения
- Уведомление приходит в течение 1-2 минут после старта атаки

**Этап 2 - Процесс боя:**
- Защиту деревни осуществляет ИИ
- Юниты и оборонительные сооружения действуют по автоматическому сценарию

**Этап 3 - Результаты атаки:**
- **Мгновенное уведомление** о результате боя:
  - "Атака отражена!" - при успешной обороне
  - "Деревня подверглась разорению" - при поражении

**Содержание отчета о нападении:**

**При успешной обороне:**
- Количество уничтоженных вражеских юнитов
- Полученные трофеи (монеты)

**При поражении:**
- Размер украденных ресурсов
- Уничтоженные здания

**Настройки уведомлений:**

**Пользовательские настройки:**
- Возможность отключения push-уведомлений
- Настройка звуковых оповещений

**Визуальное представление:**

**При входе в игру после атаки:**
- Специальный экран "Результаты обороны"
- Кнопка просмотра детальной статистики


## 7. Архитектура системы и база данных

### 7.1 Общая архитектура

**Клиент-серверная архитектура** с четким разделением ответственности:

**Компоненты системы:**
- **Frontend**: Браузерное приложение (HTML5, CSS3, JavaScript/TypeScript)
- **Backend**: Серверная логика и API (PHP)
- **Database**: Реляционная база данных (MySQL)
- **Real-time**: WebSocket соединения для чата и уведомлений

### 7.2 Структура базы данных

#### 7.2.1 Классификация таблиц по типу нагрузки

**Статические/Справочные таблицы (Static Tables)**
- `building_types` - типы зданий
- `unit_types` - типы юнитов
- `game` - существенные данные


**Основные сущности (Core Entities)**
- `users` - пользователи
- `villages` - деревни

**Быстрорастущие таблицы (Fast-Growing Tables)**
- `messages` - сообщения чата
- `battles` - записи сражений
- `army` - активные атаки

**Операционные таблицы (Operational Tables)**
- `buildings` - здания игроков
- `units` - юниты игроков

#### 7.2.2 Основные таблицы

**Таблица `users`**

| Поле | Тип | Ограничения | Описание |
|------|-----|-------------|----------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | Уникальный идентификатор |
| login | VARCHAR(50) | UNIQUE, NOT NULL | Логин пользователя |
| password | VARCHAR(255) | NOT NULL | Хеш пароля |
| name | VARCHAR(100) | NOT NULL | Отображаемое имя |
| token | VARCHAR(255) | UNIQUE | Токен авторизации |
| money | INT | DEFAULT 100 | Баланс монет |
| rating | INT | DEFAULT 0 | Рейтинг игрока |

**Таблица `villages`**

| Поле | Тип | Ограничения | Описание |
|------|-----|-------------|----------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | Уникальный идентификатор |
| user_id | INT | FOREIGN KEY (users.id) | Владелец деревни |
| x | INT | NOT NULL | Координата X на карте |
| y | INT | NOT NULL | Координата Y на карте |
| last_income_datetime | DATETIME | DEFAULT NOW() | Время последнего сбора дохода |
| attack_id | INT | Идентификатор атакующего |

**Таблица `game`**

| Поле | Тип | Ограничения | Описание |
|------|-----|-------------|----------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | Уникальный идентификатор |
| name | VARCHAR(100) | NOT NULL | Имя поля |
| value | TEXT | NOT NULL | Значение поля |

**Таблица `building_types`**

| Поле | Тип | Ограничения | Описание |
|------|-----|-------------|----------|
| id | INT | PRIMARY KEY | Уникальный идентификатор |
| type | VARCHAR(100) | NOT NULL | Тип здания: 'mine', 'ratusha', 'tower', 'wall' |
| hp | INT | DEFAULT 1 | Здоровье здания |
| price | INT | NOT NULL | Стоимость строительства |
| unlock_level | INT | NOT NULL | Требуемый уровень для покупки здания |

**Таблица `buildings`**

| Поле | Тип | Ограничения | Описание |
|------|-----|-------------|----------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | Уникальный идентификатор |
| type_id | INT | FOREIGN KEY (building_types.id) | Тип здания |
| village_id | INT | FOREIGN KEY (villages.id) | Деревня владельца |
| x | INT | NOT NULL | Координата X |
| y | INT | NOT NULL | Координата Y |
| level | INT | DEFAULT 1 | Уровень здания |
| current_hp | INT | NOT NULL | Текущее здоровье |

**Таблица `unit_types`**

| Поле | Тип | Ограничения | Описание |
|------|-----|-------------|----------|
| id | INT | PRIMARY KEY | Уникальный идентификатор |
| type | VARCHAR(100) | NOT NULL | Тип юнита |
| name | VARCHAR(100) | NOT NULL | Название юнита |
| hp | INT | DEFAULT 1 | Здоровье юнита |
| price | INT | NOT NULL | Стоимость найма |
| damage | INT | NOT NULL | Урон |
| speed | FLOAT | NOT NULL | Скорость перемещения |
| range | INT | DEFAULT 1 | Дальность атаки |
| unlock_level | INT | DEFAULT 1 | Уровень разблокировки |

**Таблица `units`**

| Поле | Тип | Ограничения | Описание |
|------|-----|-------------|----------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | Уникальный идентификатор |
| type_id | INT | FOREIGN KEY (unit_types.id) | Тип юнита |
| village_id | INT | FOREIGN KEY (villages.id) | Деревня владельца |
| x | INT | NULL | Координата X (если размещены) |
| y | INT | NULL | Координата Y (если размещены) |
| level | INT | DEFAULT 1 | Уровень юнита |
| current_hp | INT | NOT NULL | Текущее здоровье |
| on_a_crusade | TINYINT(1) | DEFAULT '0' | NOT NULL | Указывает в походе юнит или нет (0 - нет, 1 - да) |
| is_enemy | TINYINT | DEFAULT '0' | NOT NULL | Указывает союзный юнит или нет (0 - нет, 1 - да) |

**Таблица `messages`**

| Поле | Тип | Ограничения | Описание |
|------|-----|-------------|----------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | Уникальный идентификатор |
| user_id | INT | FOREIGN KEY (users.id) | Автор сообщения |
| message | TEXT | NOT NULL | Текст сообщения |
| message_type | ENUM | 'global', 'private' | Тип сообщения |
| target_user_id | INT | NULL | Получатель (для личных) |
| created | TIMESTAMP | DEFAULT NOW() | Дата отправки |
| hash | TEXT | NULL | Хеш для отслеживания прочитанных |

**Таблица `battles`**

| Поле | Тип | Ограничения | Описание |
|------|-----|-------------|----------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | Уникальный идентификатор |
| attacker_id | INT | FOREIGN KEY (users.id) | Атакующий игрок |
| defender_id | INT | FOREIGN KEY (users.id) | Защищающийся игрок |
| result | ENUM | 'attacker_win', 'defender_win' | Результат битвы |
| loot | JSON | DEFAULT '{"gold": 0}' | Добытые ресурсы |
| attacker_losses | JSON | NOT NULL | Потери атакующего |
| defender_losses | JSON | NOT NULL | Потери защищающегося |
| started_at | TIMESTAMP | NOT NULL | Начало битвы |
| ended_at | TIMESTAMP | NULL | Окончание битвы |

**Таблица `army`**

| Поле | Тип | Ограничения | Описание |
|------|-----|-------------|----------|
| army | INT | PRIMARY KEY, AUTO_INCREMENT | Уникальный идентификатор |
| userId | INT | FOREIGN KEY (users.id) | Атакующий |
| startX | INT | NOT NULL | Координата старта пути по x |
| startY | INT | NOT NULL | Координата старта пути по y |
| startTime | DATETIME | NOT NULL | Время начала пути |
| arrivalTime | DATETIME | NOT NULL | Время до конца пути |
| targetX | INT | NOT NULL | Координата конца пути по y |
| targetY | INT | NOT NULL | Координата конца пути по y |
| attackedId | INT | FOREIGN KEY (villages.id) | Целевая деревня |
| speed | FLOAT | NOT NULL | Скорость армии |
| units | TEXT | NOT NULL | Массив атакующих юнитов |


**Таблица `hashes`**

| Поле | Тип | Ограничения | Описание |
|------|-----|-------------|----------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | Уникальный идентификатор |
| chat_hash | TEXT | NOT NULL | Хеш состояния чата |

**Таблица `map_hashes`**

| Поле | Тип | Ограничения | Описание |
|------|-----|-------------|----------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | Уникальный идентификатор |
| hash | TEXT | NOT NULL | Хеш состояния карты |

#### 7.2.3 Оптимизация и индексация

**Критические индексы для производительности:**

- Пользователи и авторизация:
  - CREATE INDEX idx_users_login ON users(login);
  - CREATE INDEX idx_users_token ON users(token);
  - CREATE INDEX idx_users_rating ON users(rating DESC);

- Деревни и геопозиция:
  - CREATE INDEX idx_villages_user_id ON villages(user_id);
  - CREATE INDEX idx_villages_coordinates ON villages(x, y);
  - CREATE INDEX idx_villages_protection ON villages(protection_end) WHERE protection_end IS NOT NULL;

- Здания и юниты:
  - CREATE INDEX idx_buildings_village_id ON buildings(village_id);
  - CREATE INDEX idx_buildings_type_level ON buildings(type_id, level);
  - CREATE UNIQUE INDEX idx_buildings_position ON buildings(village_id, x, y);
  - CREATE INDEX idx_units_village_id ON units(village_id);
  - CREATE INDEX idx_units_type_count ON units(type_id, count) WHERE count > 0;

- Сообщения и чат:
  - CREATE INDEX idx_messages_created ON messages(created DESC);
  - CREATE INDEX idx_messages_user_type ON messages(user_id, message_type);
  - CREATE INDEX idx_messages_target_hash ON messages(target_user_id, hash) WHERE target_user_id IS NOT NULL;

- Боевая система:
  - CREATE INDEX idx_battles_attacker_defender ON battles(attacker_id, defender_id);
  - CREATE INDEX idx_battles_started_ended ON battles(started_at, ended_at) WHERE ended_at IS NOT NULL;
  - CREATE INDEX idx_attacks_status_time ON attacks(status, arrival_time);
  - CREATE INDEX idx_attacks_attacker_target ON attacks(attacker_id, target_village_id);

**Стратегии оптимизации:**

1. **Партиционирование для быстрорастущих таблиц:**
   - `messages` - по месяцам (`created`)
   - `battles` - по неделям (`started_at`)
   - `attacks` - по дням (`start_time`)

2. **Кэширование горячих данных:**
   - Рейтинговая таблица (топ-100) - Redis
   - Статистика игроков - Memcached
   - Глобальная карта (активные игроки) - In-memory DB

#### 7.2.4 ER-модель базы данных

┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│     users       │      │    villages     │      │ building_types  │
├─────────────────┤      ├─────────────────┤      ├─────────────────┤
│ id (PK)         │◄─────┤ id (PK)         │      │ id (PK)         │
│ login (UQ)      │      │ user_id (FK)    │      │ type            │
│ password        │      │ x, y            │      │ hp              │
│ name            │      │ last_income_    │      │ price           │
│ token (UQ)      │      │ datetime        │      │ unlock_level    │
│ money           │      │ attack_id       │      └─────────────────┘
└─────────────────┘      └─────────────────┘              │
       │                            │                     │
       │                            ▼                     ▼
       │                   ┌─────────────────┐    ┌─────────────────┐
       ▼                   │    buildings    │    │   unit_types    │
┌─────────────────┐        ├─────────────────┤    ├─────────────────┤
│    messages     │        │ id (PK)         │    │ id (PK)         │
├─────────────────┤        │ type_id (FK)    │    │ type            │
│ id (PK)         │        │ village_id (FK) │    │ hp              │
│ user_id (FK)    │        │ x, y            │    │ price           │
│ message         │        │ level           │    │ damage          │
│ created         │        │ current_hp      │    │ speed           │
└─────────────────┘        └─────────────────┘    │ range_attack    │
       │                            │             │ unit_type       │
       │                            │             │ unlock_level    │
       │                            ▼             └─────────────────┘
       │                    ┌─────────────────┐            │
       │                    │      units      │            │
       │                    ├─────────────────┤            │
       │                    │ id (PK)         │            ▼
       │                    │ type_id (FK)    │    ┌─────────────────┐
       │                    │ village_id (FK) │    │      army       │
       │                    │ x, y            │    ├─────────────────┤
       │                    │ level           │    │ army (PK)       │
       │                    │ current_hp      │    │ userId (FK)     │
       │                    │ on_a_crusade    │    │ startX, startY  │
       │                    │ is_enemy        │    │ startTime       │
       │                    └─────────────────┘    │ arrivalTime     │
       │                                           │ targetX,        |
       |                                           | targetY         │
       │                                           │ attackId        │
       │                                           │ units           │
       │                                           │ speed           │
       │                                           └─────────────────┘
       │                                                    │
       │                                          ┌─────────────────┐
       │                                          │      game       │
       │                                          ├─────────────────┤
       │                                          │ id (PK)         │
       │                                          │ name            │
       │                                          │ value           │
       │                                          └─────────────────┘
       │
┌─────────────────┐      ┌─────────────────┐
│    hashes       │      │   map_hashes    │
├─────────────────┤      ├─────────────────┤
│ id (PK)         │      │ id (PK)         │
│ chat_hash       │      │ hash            │
└─────────────────┘      └─────────────────┘

**Ключевые связи:**
- `users(1) -> villages(1)` - Один пользователь = одна деревня
- `villages(1) -> buildings(N)` - В деревне много зданий
- `villages(1) -> units(N)` - В деревне много юнитов
- `users(1) -> messages(N)` - Пользователь отправляет много сообщений
- `building_types(1) -> buildings(N)` - Тип здания у многих экземпляров
- `unit_types(1) -> units(N)` - Тип юнита у многих экземпляров
- `user(1) -> army(N)` - Пользователь может иметь несколько армий




