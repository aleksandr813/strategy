# Описание API
Здесь описано всё АПИ, используемое в приложении, с описанием структур данных.


**Содержание**
1. Общее
    * 1.1. Адрес сервера
    * 1.2. Используемый протокол
2. Структуры данных
    * 2.1. Общий формат ответа
    * 2.2. Пользователь
    * 2.3. Сообщение
    * 2.4. Типы зданий
3. Список запросов
    * 3.1. Общие ошибки
4. Подробно
    * 4.1. login
    * 4.2. logout
    * 4.3. registration
    * 4.4. sendMessage
    * 4.5. getMessages
    * 4.6. getBuildingTypes
    * 4.7. getBuildings
    * 4.8. deleteBuilding
    * 4.9. buyBuilding
    * 4.10. upgradeBuilding
    * 4.11. getUnitTypes
    * 4.12. buyUnit
    * 4.13. getUnits
    * 4.14. getIncome
    * 4.15. moveUnits
    * 4.16. takeDamage
    * 4.17. sendArmy
    * 4.18. moveArmyBack
    * 4.19. getMap
    * 4.20. getUserArmies

## 1. Общее
### 1.1. Адрес сервера
`http://strategy/api`

### 1.2. Используемый протокол
API полностью реализовано на http(s). 

Формат возвращаемых значений `JSON`.

Все методы, если это особо не оговорено, имеют тип `GET`.


## 2. Структуры данных
### 2.1. Общий формат ответа
`T` - какие-то данные. В случае успешного ответа возвращается `result = 'ok'` и поле `data` с данными.

В случае ошибки возвращается `result = 'error'` и поле `error` с кодом и текстом ошибки
```
Answer<T>: {
    result: 'ok' | 'error';
    data?: T;
    error?: {
        code: number;
        text: string;
    };
}
```

### 2.2. Пользователь
```
User: {
    id: number;
    token: string;
    name: string;
}
```

### 2.3. Сообщение
```
Message: {
    message: string;
    author: string;
    created: string;
}
```

### 2.4. Типы зданий
```
BuildingTypes: {
    id: number,
    type: string,
    name: string,
    sprite_id: number,
    hp: number,
    price: number
}
```
### 2.5. Здание
```
Buildings: {
    id: number;
    type_id: number;
    village_id: number;
    x: number;
    y: number;
    level: number;
    current_hp: number
}
```

```

### 2.7. Юниты
```
Units: {
    id: number;
    type_id: number;
    village_id: number;
    x: number;
    y: number;
    level: number;
    current_hp: number;
}
```

### 2.8. Типы юнитов
```
Buildings: {
    id: number;
    type: string;
    name: string;
    hp: number;
    price: number;
}
```

## 3. Список запросов
| Название | О чем |
| - | - |
| login | Авторизация пользователя |
| logout | Логаут пользователя |
| registration | Регистрация пользователя |
| sendMessage | Отправить сообщение в чат |
| getMessages | Получить сообщения в чате |
| getBuildingTypes | Получить типы зданий |
| getBuildings | Получить все здания в деревне |
| deleteBuilding | Удалить здание из деревни |
| buyBuilding | Купить здание в деревню |
| getUnitTypes | Получить типы юнитов |
| upgradeBuilding | Улучшить здание |
| buyUnit | Купить юнита в деревню |
| getUnits | Получить всех юнитов в деревне |
| getIncome | Получить и обновить доход с шахты |
| moveUnits | Обновить положение юнитов |
| takeDamage | Обновить здоровье юнитов |
| sendArmy | Отправить армию в атаку на деревню |
| getMap | Обновление карты по хешу, возвращает деревни и перемещение армий |
| getUserArmies | Получение всех действующих армий пользователя |

### 3.1. Общие ошибки
* `101` - если не передан параметр `method`
* `102` - если переданное значение в параметре `method` не обрабатывается
* `242` - не переданы все необходимые параметры
* `9000` - неизвестная ошибка

## 4. Подробно
### 4.1. login
Авторизация пользователя в системе

**Параметры**
```
{
    login: string; - логин пользователя
    hash: string; - контрольная сумма, равная hash = md5(nd5(login + password) + rnd)
    rnd: number; - случайно целое число
}
```
**Успешный ответ**
```
    Answer<User>
```
**Ошибки**
* `1002` - неверный пароль
* `1005` - неверный логин
* `1007` - неправильная длина логина
* `1008` - логин начинается с цифры или подчеркивания
* `1009` - недопустимые символы в логине
* `1010` - логин содержит пробелы или специальные символы


### 4.2. logout
Вылогин пользователя из системы

**Параметры**
```
{
    token: string
}
```
**Успешный ответ**
```
    Answer<true>
```
**Ошибки**
* `1003` - неверный пароль


### 4.3. registration
Зарегистрировать нового ползователя

**Параметры**
```
{
    login: string; - логин пользователя
    password: string; - хеш пароля: md5(login + password)
    name: string; - имя пользователя
}
```
**Успешный ответ**
```
    Answer<User>
```
**Ошибки**
* `1001` - такой логин уже существует
* `1004` - ошибка при регистрации пользователя
* `1007` - неправильная длина логина
* `1008` - логин начинается с цифры или подчеркивания
* `1009` - недопустимые символы в логине
* `1010` - логин содержит пробелы или специальные символы
* `1090` - ошибка создания деревни


### 4.4. sendMessage
Послать сообщение в чат

**Параметры**
```
{
    token: string; - токен
    message: string; - текст сообщения
}
```
**Успешный ответ**
```
    Answer<true>
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован


### 4.5. getMessages
Получить все сообщения чата

**Параметры**
```
{
    token: string; - токен
    hash: string; - хеш-сумма чата
}
```
**Успешный ответ**
```
    Answer<{
        messages: Message[]; - список сообщений
        hash: string; - новый хеш чата
    }>
```
**Примечание**: в случае отсутствия новых сообщений будет ответ:
```
    Answer<
        hash: string; - новый хеш чата
    >
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован


### 4.6. getBuildingTypes
Получить все типы зданий

**Параметры**
```
{
    token: string; - токен
}
```
**Успешный ответ**
```
    Answer<{
        buildingTypes: BuildingTypes[]
    }>
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован


### 4.7. getBuildings
Получить все здания в деревне

**Параметры**
```
{
    token: string; - токен
}
```
**Успешный ответ**
```
    Answer<{
        id: number; - id здания, 
        typeId: number; - id типа здания, 
        villageId: number; - id деревни, 
        x: number; - координата по x, 
        y: number; - координата по y,
        level: number; - уровень здания,
        currentHp: number; - текущее здоровье здания,
        type: string; - тип здания
    }>
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован


### 4.8. deleteBuilding
Удалить здание из деревни

**Параметры**
```
{
    token: string; - токен
    id: number; - id здания 
}
```
**Успешный ответ**
```
    Answer<true>
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован
* `303` - ошибка удаления здания (Failed to delete building)
* `307` - здание запрещенное к покупке и удалению (Building that is prohibited for buy and delete)


### 4.9. buyBuilding
Купить здание в деревню

**Параметры**
```
{
    token: string; - токен
    typeId: number; - id типа здания 
    typeId: number; - id типа здания
    x: number; координаты размещения здания по x
    y: number; координаты размещения здания по y
}
```
**Успешный ответ**
```
    Answer<{
        money: money;
    }>
    Answer<true>
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован
* `301` - неудалось купить здание (Failed to buy building)
* `305` - недостаточно монет для покупки здания (Not enough funds to buy)
* `307` - здание запрещенное к покупке и удалению (Building that is prohibited for buy and delete)
* `310` - деревня не найдена (Village not found)
* `311` - не верные координаты (Coordinates not defined)


### 4.10. upgradeBuilding
Улучшить здание

**Параметры**
```
{
    token: string; - токен
    buildingId: number; - id здания
    typeId: number; - id типа здания
}
```
**Успешный ответ**
```
    Answer<{
        money: money;
    }>
    Answer<true>
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован
* `302` - неудалось улучшить здание (Failed to upgrade building)
* `305` - недостаточно монет для покупки здания (Not enough funds to buy)
* `310` - деревня не найдена (Village not found)
* `312` - максимальный уровень (Maximum level)


### 4.11. getUnitTypes
Получить все типы юнитов

**Параметры**
```
{
    token: string; - токен
}
```
**Успешный ответ**
```
    Answer<{
        unitTypes: UnitTypes[]
    }>
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован


### 4.12. buyUnit
Купить юнита в деревню

**Параметры**

```
{ token: string; - токен
    typeId: number; - id типа юнита
    x: number; - координаты размещения юнита по x
    y: number; - координаты размещения юнита по y 
}
```
**Успешный ответ**
```

    Answer<{
        money: money;
    }>
```

**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован
* `501` - неудалось купить юнита (Failed to buy unit)
* `305` - недостаточно монеток для покупки юнита (Not enough funds to buy)
* `310` - деревня не найдена (Village not found)
* `311` - не верные координаты (Coordinates are busy)


### 4.13. getUnits
Получить всех юнитов в деревне

**Параметры**
```
{ 
    token: string; - токен 
}
```
**Успешный ответ**
```
    Answer<{
        id: number; - id юнита, 
        typeId: number; - id типа юнита, 
        villageId: number; - id деревни, 
        x: number; - координата по x, 
        y: number; - координата по y,
        level: number; - уровень юнита,
        currentHp: number; - текущее здоровье юнита,
        type: string; - тип юнита
    }>
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован


### 4.14. getIncome
Получить и обновить доход с шахты

**Параметры**
```
{
    token: string; - токен
}
```
**Успешный ответ**
```
    Answer<{
        money: money;
    }>
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован
* `310` - деревня не найдена (Village not found)
* `410` - шахта не найдена (Mine is not found)


### 4.15. moveUnits
Обновить положение юнитов

**Параметры**
```
{
    token: string; - токен
    units: array; - массив юнитов с их id, x, y
}
```
**Успешный ответ**
```
    Answer<{
        true
    }>
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован
* `310` - деревня не найдена (Village not found)
* `504` - Ошибка перемещения юнитов (Units movement error)

### 4.16. takeDamage
Обновить положение юнитов

**Параметры**
```
{
    token: string; - токен
    units: array; - массив юнитов с их id, hp
}
```
**Успешный ответ**
```
    Answer<{
        true
    }>
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован
* `315` - Деревня не найдена
* `510` - Ошибка операции получения дамага


### 4.17. sendArmy
Отправить юнитов в атаку на деревню

**Параметры**
```
{
    token: string; - токен
    target: number; - id атакуемой деревни
    units: array; - массив id юнитов
}
```
**Успешный ответ**
```
    Answer<{
        money: number; - количество монет
    }>
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован
* `305` - Недостаточно средств для совершения операции (Failed to delete building)
* `315` - Деревня не найдена
* `600` - Армия не может быть пустой (An army cannot be empty)
* `601` - Ошибка отправки армии (Army dispatch error)

### 4.18. moveArmyBack
Возвращет юнитов в деревню


**Параметры**
```
{
    token: string; - токен
}
```

**Успешный ответ**
```
    Answer<{
        true
    }>
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован
* `305` - Недостаточно средств для совершения операции (Failed to delete building)
* `315` - Деревня не найдена
* `600` - Армия не может быть пустой (An army cannot be empty)
* `601` - Ошибка отправки армии (Army dispatch error)


### 4.19. getMap
Обновление карты по хешу, возвращает деревни и перемещение армий

**Параметры**
```
{
    token: string; - токен
    hash: string; - hash
}
```
**Успешный ответ**
```
    Answer<{
        hash: hash;
        villages: array; - массив деревень
        armies: array; - массив армий
    }>
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован


### 4.20. getUserArmies
Получение всех действующих армий пользователя

**Параметры**
```
{
    token: string; - токен
}
```
**Успешный ответ**
```
    Answer<{
        armies: array; - массив юнитов
        attackId: number; - id атакуемой деревни
        speed: number; - скорость армии
    }>
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован
* `603` - Армии не нейдены